services:
  db:
    image: mariadb:11.4
    container_name: fineract-db
    volumes:
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
    environment:
      MYSQL_ROOT_PASSWORD: mysql
      MYSQL_DATABASE: fineract_tenants
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3307:3306"
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 10s
      retries: 10

  fineract:
    image: apache/fineract:latest
    container_name: fineract
    depends_on:
      db:
        condition: service_healthy
    environment:
      # ── HikariCP / Database Pool ──────────────────────────────────────
      FINERACT_HIKARI_DRIVER_SOURCE_CLASS_NAME: org.mariadb.jdbc.Driver
      FINERACT_HIKARI_JDBC_URL: jdbc:mariadb://db:3306/fineract_tenants
      FINERACT_HIKARI_USERNAME: root
      FINERACT_HIKARI_PASSWORD: mysql
      FINERACT_HIKARI_MINIMUM_IDLE: 3
      FINERACT_HIKARI_MAXIMUM_POOL_SIZE: 10
      FINERACT_HIKARI_AUTO_COMMIT: "true"
      FINERACT_HIKARI_TEST_QUERY: SELECT 1
      # ── Default Tenant DB ────────────────────────────────────────────
      FINERACT_DEFAULT_TENANTDB_HOSTNAME: db
      FINERACT_DEFAULT_TENANTDB_PORT: "3306"
      FINERACT_DEFAULT_TENANTDB_UID: root
      FINERACT_DEFAULT_TENANTDB_PWD: mysql
      FINERACT_DEFAULT_TENANTDB_CONN_PARAMS: ""
      FINERACT_DEFAULT_TENANTDB_IDENTIFIER: default
      FINERACT_DEFAULT_TENANTDB_NAME: fineract_default
      FINERACT_DEFAULT_TENANTDB_DESCRIPTION: Default Demo Tenant
      FINERACT_DEFAULT_TENANTDB_TIMEZONE: Asia/Kolkata
      FINERACT_DEFAULT_MASTER_PASSWORD: fineract
      # ── Server / App ─────────────────────────────────────────────────
      FINERACT_SERVER_SSL_ENABLED: "true"
      FINERACT_INSECURE_HTTP_CLIENT: "true"
      SPRING_PROFILES_ACTIVE: test,diagnostics
      FINERACT_REMOTE_JOB_MESSAGE_HANDLER_SPRING_EVENTS_ENABLED: "true"
      JAVA_TOOL_OPTIONS: >-
        -Xmx1G --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED
    ports:
      - "8443:8443"
